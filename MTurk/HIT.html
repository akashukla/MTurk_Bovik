<meta charset="utf-8"/>
<script src="https://assets.crowd.aws/crowd-html-elements.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script> 
<script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-csv/0.71/jquery.csv-0.71.min.js"></script>

<link href="http://static.jquery.com/ui/css/demo-docs-theme/ui.theme.css" media="all" rel="stylesheet" type="text/css">
<link href="http://code.jquery.com/ui/1.8.18/themes/base/jquery-ui.css" media="all" rel="stylesheet" type="text/css">

<crowd-form answer-format="flatten-objects">
  <crowd-instructions link-text="View instructions" link-type="button">
    <short-summary>
      <p>Adjust the slider so that the image is as compressed as it can be without changing the image quality.</p>
    </short-summary>

    <detailed-instructions>
      <h3>Provide more detailed instructions here</h3>
      <p>The slider bar under each image controls the compression level of the image.</p>
    </detailed-instructions>

    <positive-example>
      <p>Provide an example of a good answer here</p>
      <p>Explain why it's a good answer</p>
    </positive-example>

    <negative-example>
      <p>Provide an example of a bad answer here</p>
      <p>Explain why it's a bad answer</p>
    </negative-example>
  </crowd-instructions>

  <div>
    <p>(Sandbox version)</p>
    <p>How old are you?</p>
    <crowd-input name="age" placeholder="Age" required></crowd-input>
  </div>


<div>
    <img id="source_image"  style="display: none;"> 
    <img id="result_image">
    <fieldset style="width:800px">
        <legend>Compressor settings</legend>
        <div id="slider-range-max"></div>
        <div>
            Compression ratio : <input id="jpeg_encode_quality" readonly='true' size='3' type="text" value="40"></input>
        </div>
    </fieldset>

</div>
<div>
    <h2 class="btn btn-primary">click for next image </h2>
    <input type="button" onclick="setImageb(1)" id='next button' name='next button' class="btn btn-primary">Next Button</input>
</div>
 
<script>
    var names
    var nexts = 0 
    var hit_list_url = "https://snako.s3.us-east-2.amazonaws.com/1_hit_list.csv"
    var hit_number_url = "https://snako.s3.us-east-2.amazonaws.com/1_hit_number.txt"
    var proxy_url = "https://cors-anywhere.herokuapp.com/";
    var bucket_url = "https://snako.s3.us-east-2.amazonaws.com/";
    var allText;
    var hit_sets;
    var hit_number;

    function setImageb(button){
        source_image.src = "https://snako.s3.us-east-2.amazonaws.com/" + names[nexts+1];
        result_image.src = "https://snako.s3.us-east-2.amazonaws.com/" + names[nexts+1];
           //Slider init
           $("#slider-range-max").slider({
               range: "max",
               value: 40,
               min: 0,
               max: 40,
               slide: function(event, ui) {
                   $("#jpeg_encode_quality").val(ui.value);
               }

           });
        nexts = nexts+1;
    }


    
    $.get(proxy_url + hit_number_url, function( data ) {
      hit_number = data;
      $.ajax({
    	    type: "GET",  
    	    url: proxy_url + hit_list_url,
    	    dataType: "text",       
    	    success: function(response)  
    	    {
    		    var option = "random";
    		    hit_sets = $.csv.toArrays(response);
    		    var i_set = (hit_number % hit_sets.length)
    		    var hit_set = hit_sets[i_set].toString();
    		    names = hit_set.split(",");
                image_name=names[0]
    		    source_image.src = "https://snako.s3.us-east-2.amazonaws.com/" + image_name;
    		    result_image.src = "https://snako.s3.us-east-2.amazonaws.com/" + image_name;
    		    
            }   
        });
    });


       $(function(){
        var source_image = document.getElementById('source_image');
        var downloadingImage = new Image();
        downloadingImage.onload = function(){
            source_image.src = this.src;   
        };
        downloadingImage=toDataURL(source_image.src, function(dataUrl) {
          console.log('RESULT:', dataUrl)
        })


        var result_image = document.getElementById('result_image');
        var downloadingImage2 = new Image();
        downloadingImage2.onload = function(){
            result_image.src = this.src;   
        };
        downloadingImage2=toDataURL(result_image.src, function(dataUrl) {
          console.log('RESULT:', dataUrl)
        })

           var output_format = "jpg";

           //Slider init
           $("#slider-range-max").slider({
               range: "max",
               value: 40,
               min: 0,
               max: 40,
               slide: function(event, ui) {
                   $("#jpeg_encode_quality").val(ui.value);
               }

           });
           $("#jpeg_encode_quality").val($("#slider-range-max").slider("value"));

           $( "#slider-range-max" ).on("slide", function( event, ui ) {
               

               var encodeQuality = document.getElementById('jpeg_encode_quality');
               var source_image = document.getElementById('source_image');
               var result_image = document.getElementById('result_image');
               if (source_image.src == "") {
                   alert("You must load an image first!");
                   return false;
               }

               var quality = parseInt(encodeQuality.value);        
               result_image.src = compress(source_image,quality,output_format).src;   

    } );

       });

       function compress(source_img_obj, quality, output_format){
                
                var mime_type;
                if(output_format==="png"){
                   mime_type = "image/png";
                } else if(output_format==="webp") {
                   mime_type = "image/webp";
                } else {
                   mime_type = "image/jpeg";
                }

                var cvs = document.createElement('canvas');
                cvs.width = source_img_obj.naturalWidth;
                cvs.height = source_img_obj.naturalHeight;
                var ctx = cvs.getContext("2d").drawImage(source_img_obj, 0, 0);
                var newImageData = cvs.toDataURL(mime_type, quality/100);
                var result_image_obj = new Image();
                result_image_obj.src = newImageData;
                return result_image_obj;
       };

       function toDataURL(url, callback) {
          var xhr = new XMLHttpRequest();
          xhr.onload = function() {
            var reader = new FileReader();
            reader.onloadend = function() {
              callback(reader.result);
            }
            reader.readAsDataURL(xhr.response);
          };
          xhr.open('GET', url);
          xhr.responseType = 'blob';
          xhr.send();
        }

        toDataURL(source_image.src, function(dataUrl) {
          console.log('RESULT:', dataUrl)
        })
    </script>
</body>
</html>
