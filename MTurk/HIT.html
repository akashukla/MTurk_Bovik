<!doctype html>
<html>
<head>
<!--<meta charset="utf-8">-->
<!--<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />-->
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://assets.crowd.aws/crowd-html-elements.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script> 
<script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-csv/0.71/jquery.csv-0.71.min.js"></script>
<script src="https://sdk.amazonaws.com/js/aws-sdk-2.283.1.min.js"></script>
<link href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css" media="all" rel="stylesheet" type="text/css">
<link href="https://static.jquery.com/ui/css/demo-docs-theme/ui.theme.css" media="all" rel="stylesheet" type="text/css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js"></script>
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css">
<style>
  #slider{
    width: 600px;
  }
  #slider.ui-slider-range { background: #f6931f; }
  #slider.ui-slider-handle{ border-color: #729fcf;}

  #progressbar{
    width: 600px;
    justify-content: center;
  }

  #Next_button {
  background-color: #4CAF50; /* Green */
  border: none;
  color: white;
  padding: 15px 32px;
  text-align: center;
  text-decoration: none;
  display: inline-block;
  font-size: 16px;
  margin: 4px 2px;
  cursor: pointer;
  }
  #submitButton {
  background-color: #4CAF50; /* Green */
  border: none;
  color: white;
  padding: 15px 32px;
  text-align: center;
  text-decoration: none;
  display: inline-block;
  font-size: 16px;
  margin: 4px 2px;
  cursor: pointer;
  }
</style>

<script>
    var golden_image_study = true;
    var names;
    var n_slider_levels = 50; 
    var nexts = 0; 
    var bucket_url = "https://snako.s3.us-east-2.amazonaws.com/";
    var hit_list_url = "https://snako.s3.us-east-2.amazonaws.com/1_hit_list.csv"
    var key = "1_hit_number0.txt";
    var hit_number_url = bucket_url + key;
    var proxy_url = "https://cors-anywhere.herokuapp.com/";
    // var proxy_url = "";
    var allText;
    var hit_sets;
    var hit_number;
    var slider_vals = '';
    var phase = 'beginning';
    var tutorial_names = ['AVA__809598.jpg', 'EMOTIC__COCO_train2014_000000154329.jpg', 'EMOTIC__COCO_train2014_000000128826.jpg'] // 'EMOTIC__COCO_train2014_000000104079.jpg', 
    var golden_names = ['AVA__20278.jpg', 'EMOTIC__4wl5mafxcb0nacmnzr.jpg', 'EMOTIC__COCO_train2014_000000571644.jpg', 
                        'EMOTIC__COCO_val2014_000000031983.jpg', 'EMOTIC__COCO_val2014_000000045685.jpg', 
                        'EMOTIC__COCO_val2014_000000147471.jpg', 'EMOTIC__COCO_val2014_000000464134.jpg', 
                        'EMOTIC__COCO_val2014_000000534041.jpg', 'JPEGImages__2007_003137.jpg', 
                        'JPEGImages__2008_002845.jpg', 'JPEGImages__2008_003688.jpg', 'JPEGImages__2008_003701.jpg', 
                        'JPEGImages__2008_004077.jpg', 'JPEGImages__2008_005266.jpg', 'JPEGImages__2008_006076.jpg', 
                        'JPEGImages__2008_006461.jpg', 'JPEGImages__2008_006554.jpg', 'JPEGImages__2008_006946.jpg', 
                        'JPEGImages__2008_007218.jpg', 'JPEGImages__2008_008544.jpg', 'JPEGImages__2009_000015.jpg', 
                        'JPEGImages__2009_001078.jpg', 'JPEGImages__2009_002872.jpg', 'JPEGImages__2009_002893.jpg', 
                        'JPEGImages__2009_004426.jpg', 'JPEGImages__2010_000088.jpg', 'JPEGImages__2010_002618.jpg', 
                        'JPEGImages__2010_003648.jpg', 'JPEGImages__2010_004257.jpg', 'JPEGImages__2011_000180.jpg', 
                        'JPEGImages__2011_002511.jpg', 'JPEGImages__2011_004079.jpg', 'JPEGImages__2011_006006.jpg', 
                        'JPEGImages__2011_007016.jpg', 'JPEGImages__2011_007090.jpg', 'JPEGImages__2012_000805.jpg', 
                        'JPEGImages__2012_003188.jpg', 'JPEGImages__2012_003896.jpg', 'JPEGImages__2012_004289.jpg', 
                        'VOC2012__2008_001175.jpg', 'VOC2012__2008_001855.jpg', 'VOC2012__2008_002589.jpg', 
                        'VOC2012__2008_003036.jpg', 'VOC2012__2008_004536.jpg', 'VOC2012__2008_008339.jpg', 
                        'VOC2012__2008_008503.jpg', 'VOC2012__2009_000151.jpg', 'VOC2012__2009_000659.jpg', 
                        'VOC2012__2009_000802.jpg', 'VOC2012__2009_001550.jpg', 'VOC2012__2009_002175.jpg', 
                        'VOC2012__2009_002794.jpg', 'VOC2012__2009_003177.jpg', 'VOC2012__2009_003324.jpg', 
                        'VOC2012__2009_004324.jpg', 'VOC2012__2010_000853.jpg', 'VOC2012__2010_005622.jpg', 
                        'VOC2012__2011_002173.jpg', 'VOC2012__2011_002215.jpg', 'VOC2012__2011_002960.jpg', 
                        'VOC2012__2011_003123.jpg', 'VOC2012__2011_003969.jpg', 'VOC2012__2011_005123.jpg', 
                        'VOC2012__2012_001367.jpg', 'VOC2012__2012_003683.jpg']
                         
    var tutorial_nexts = -1; // index for which tutorial image to display
    var first_image = true;
    var slight_change;
    
    // runs when the window loads
    // shows tutorial, hides everything else
    function init(){
        showClass('begin_class');
        hideClass('image_class');
        hideClass('end_class'); 
        hideClass('slider_class');
        hideClass('tutorial_complete_class');
        hideClass('tutorial_text_class');
    }
    window.onload = init;
    
    // shows all HTML elements in the specified class (except source_image)
    function showClass(class_name){
        var x = document.getElementsByClassName(class_name); 
        for (var i = 0; i < x.length; i++) { 
            if(x[i].id != 'source_image'){
                x[i].style.display = "block"; 
            }
        } 
    }
    
    // hides all HTML elements in the specified class
    function hideClass(class_name){
        var x = document.getElementsByClassName(class_name); 
        for (var i = 0; i < x.length; i++) { 
            x[i].style.display = "none"; 
        } 
    }
    
    // runs when "Next" button is pressed
    // note: tutorial_nexts and nexts increment at end of function
    function setImageb(button){
        // if showing tutorial
        if(phase === 'beginning'){
            // if tutorial complete
            if(tutorial_nexts === tutorial_names.length-1){
                showClass('tutorial_complete_class');
                hideClass('slider_class');
                hideClass('image_class');
                hideClass('tutorial_text_class');
                phase = 'study';
                get_set();
            // if showing a tutorial image
            } else { 
                // if showing first tutorial image
                document.getElementById("crowd-instr").style.display = "block";
                if(tutorial_nexts === -1){
                    showClass('tutorial_text_class');
                    showClass('slider_class');
                    showClass('image_class');
                    hideClass('begin_class');
                }
                // showing the next image (uncompressed)
                var url = proxy_url + bucket_url + tutorial_names[tutorial_nexts+1];
                result_image.src = url;
                source_image.src = url;
                
                document.getElementById('Next_button').style = 'visibility: hidden';
                
                //Slider init
                $("#slider").slider({
                    orientation: "horizontal",
                    range: "max",
                    value: n_slider_levels,
                    min: 0,
                    max: n_slider_levels,
                });
                document.getElementById('slider').style.background='#4CAF50';
                $("#jpeg_encode_quality").val($("#slider").slider("value"));
                
                tutorial_nexts = tutorial_nexts+1;
            }
        }
        
        // if showing non-tutorial images
        else if(phase === 'study'){
            // normal operation 
            if (first_image === false){
                slider_vals = slider_vals + $("#slider").slider("value").toString() + ',';
            // only runs when transitioning from 'end of tutorial' screen to 'actual study' screen    
            } else { 
                first_image = false;
                hideClass('tutorial_complete_class');
                showClass('image_class');
                showClass('slider_class');
            }
            
            // updating image
            document.getElementById('result_image').crossOrigin = 'anonymous';
            document.getElementById('source_image').crossOrigin = 'anonymous';
            var image_src = proxy_url + bucket_url + names[nexts];
            source_image.src = image_src;
            result_image.src = image_src;

            document.getElementById('Next_button').style = 'visibility: hidden';

            $( "#progressbar" ).progressbar({
                value: nexts,
                create: function(event, ui) {$(this).find('.ui-widget-header').css({'background-color':'lightskyblue'})}
            });
            //document.getElementById('progressbar').style.width= (w + nexts) +'%';
            document.getElementById("progress_bar_items").style.display = "block";
            //Slider init
            $("#slider").slider({
                orientation: "horizontal",
                range: "max",
                value: n_slider_levels,
                min: 0,
                max: n_slider_levels
            });
            $("#jpeg_encode_quality").val($("#slider").slider("value"));

            // end screen
            if(nexts === names.length){ 
                slider_values.value = slider_vals;
                hideClass('image_class');
                hideClass('slider_class');
                showClass('end_class');
                document.getElementById('submitButton').style = 'display: block;';
                document.getElementById('Next_button').style = 'display: none;';
            }
            
            nexts = nexts+1;
        } else { 
            console.log('Not supposed to be here');
        }
    }

    // overwrites the set index file in bucket with new index
    function update_hit_number(num){
        // configure identity pool
        AWS.config.update({
          region: 'us-east-2',
          credentials: new AWS.CognitoIdentityCredentials({
            IdentityPoolId: 'us-east-2:cdec4f3c-4db2-46ea-86b1-a2081d62859e'
          })
        });
        
        // create s3 object
        var s3 = new AWS.S3({
          apiVersion: "2006-03-01",
          params: { Bucket: "snako" }
        });
        
        // var params = {
        //   Bucket: "snako", 
        //   Key: key
        // };
        // s3.getObject(params, function(err, data) {
        //     if (err) { // an error occurred
        //         // console.log(err, err.stack);
        //         console.log('error');
        //     } 
        //     else {
        //         // console.log(data);
        //         console.log('1');
        //     }; 
        // });

        // make the new text file (with updated set index) that is to be uploaded
        var blob = new Blob([num.toString()], {type:"text/plain"});  

        // upload the file
        params = {Bucket: 'snako', 
                  Key: key, 
                  Body: blob,
                  ACL: 'public-read-write',
                      
        };
        s3.upload(params, function(err, data) {
            console.log(err, data);
            // console.log('error');
        });
        
        // // Old code we want to save in case something goes wrong
        // var params = {
        //   AccessControlPolicy: {
        //   }, 
        //   Bucket: "snako", 
        //   GrantFullControl: "uri=http://acs.amazonaws.com/groups/global/AllUsers",     
        //   Key: key,
        //  };
        //  s3.putObjectAcl(params, function(err, data) {
        //   if (err) console.log(err, err.stack); // an error occurred
        //   else     console.log(data);           // successful response
        //  });
        // Use S3 ManagedUpload class as it supports multipart uploads
        // var upload = new AWS.S3.ManagedUpload({
        // params: params
        // {
        //   Bucket: "snako",
        //   Key: key,
        //   Body: blob,
        //   ACL: "public-read"
        // }
        // });
        
        // var promise = upload.promise();
        // promise.then(
        // function(data) {
        //   alert("Successfully uploaded file.");
        // },
        // function(err) {
        //   return alert("There was an error in updating the HIT number: ", err.message);
        // }
        // );
    }

    // get hit_list.csv and hit_number
    // hit_number: the set index
    // hit_list.csv: 2d array of sets
    function get_set(){
        $.get(proxy_url + hit_number_url, function( data ) {
            hit_number = parseInt(data);
            console.log('hit_number original read: ', data);
            $.ajax({
        	    type: "GET",  
        	    url: proxy_url + hit_list_url,
        	    dataType: "text",       
        	    success: function(response)  
        	    {
        		    var set_number = document.getElementById("set_number"); // the element that will export the set number in the results csv
        		    set_number.value = hit_number;
        		    hit_sets = $.csv.toArrays(response);
        		    var i_set = (hit_number % hit_sets.length)
        		    var hit_set = hit_sets[i_set].toString();
        		    console.log('i_set: ', i_set);
        		    if(golden_image_study === true){
        		        names = golden_names;
        		      //  names = names.slice(0,3);
        		    } else {
            		    names = hit_set.split(",");
            		  //  names = names.slice(0,3);
        		    }
        		    update_hit_number(hit_number+1);
                }   
            });
        });
    }

    $(function(){
        var source_image = document.getElementById('source_image');
        var downloadingImage = new Image();
        downloadingImage.onload = function(){
            source_image.src = this.src;   
        };
        downloadingImage=toDataURL(source_image.src, function(dataUrl) {
            console.log('RESULT:', '1') // dataUrl
        })
        var result_image = document.getElementById('result_image');
        var downloadingImage2 = new Image();
        downloadingImage2.onload = function(){
            result_image.src = this.src;   
        };
        downloadingImage2=toDataURL(result_image.src, function(dataUrl) {
          console.log('RESULT:', '1') // dataUrl
        })
        var output_format = "jpg";

        //Slider init
        $("#slider").slider({
            orientation: "horizontal",
            range: "max",
            value: 40,
            min: 0,
            max: 40,

            slide: function(event, ui) {
                $("#jpeg_encode_quality").val(ui.value);
            }
        });
        $("#jpeg_encode_quality").val($("#slider").slider("value"));
        $( "#slider" ).on("slide", function( event, ui ) {
                document.getElementById('result_image').style.display = 'block';
              document.getElementById('source_image').style.display = 'none';
           
            var encodeQuality = document.getElementById('jpeg_encode_quality');
            var source_image = document.getElementById('source_image');
            var result_image = document.getElementById('result_image');
            if (source_image.src == "") {
                alert("You must load an image first!");
                return false;
            }
            var quality = parseInt(encodeQuality.value);        
            result_image.src = compress(source_image,quality,output_format).src;  
            
            document.getElementById('Next_button').style = 'visibility: visible';

        });
    });

    function compress(source_img_obj, quality, output_format){
        var mime_type;
        if(output_format==="png"){
           mime_type = "image/png";
        } else if(output_format==="webp") {
           mime_type = "image/webp";
        } else {
           mime_type = "image/jpeg";
        }

        var cvs = document.createElement('canvas');
        cvs.width = source_img_obj.naturalWidth;
        cvs.height = source_img_obj.naturalHeight;
        var ctx = cvs.getContext("2d").drawImage(source_img_obj, 0, 0);
        var newImageData = cvs.toDataURL(mime_type, 2*quality/100);
        var result_image_obj = new Image();
        result_image_obj.src = newImageData;
        return result_image_obj;
    };

    function toDataURL(url, callback) {
        var xhr = new XMLHttpRequest();
        xhr.onload = function() {
            var reader = new FileReader();
            reader.onloadend = function() {
                callback(reader.result);
            }
            reader.readAsDataURL(xhr.response);
        };
        xhr.open('GET', url);
        xhr.responseType = 'blob';
        xhr.send();
    }

    toDataURL(source_image.src, function(dataUrl) {
        console.log('RESULT:', dataUrl)
    })
</script>
</head>

<body>
    <div class = "container">
<h1 style="text-align: center;" class="display-4">Optimal Image Compression - Human Study</h1>
<hr>
<br>

<crowd-form answer-format="flatten-objects" style="text-align: center;">
  <crowd-instructions style="display: none;" link-text="View instructions" link-type="button" id ="crowd-instr" >
      <br>
    <short-summary>
        
        <p><b>Your task:</b> Adjust the slider to compress the image and try to find the point at which the <b>quality of the image just begins to change</b>.</p>

      <img src="https://media.giphy.com/media/J684vIRmGIDRLUskiJ/giphy.gif">
    </short-summary>

  <detailed-instructions>
   
      <p>The slider bar under each image controls the compression level of the image. The highest quality value is 
      50 and the lowest quality value is 0. Moving the slider to the right will lessen the quaity of the image.</p>
      <p>Adjust the slider to try to find the point at which the <b>quality of the image just begins to change</b>. 
      In essence, how far left can you move the slider before the image starts to lose its quality? Your task is 
      not to rate the aesthetic appeal of the image. Rather, it is to indicate how much an image can be compressed
      without decreasing its original quality.</p>
      <p><b>Note:</b> The images may start off with different initial qualities. Base your answer relative to 
      the pristine uncompressed image, when the slider bar is all the way to the right (at 50). With some 
      images, you may be able to move the slider a lot without affecting the quality of the image, while with
      other images, you may not need to move the slider before noticing a drop in quality.</p> 
      <p>Perform this task for all of the images.</p>  
      <img src="https://media.giphy.com/media/J684vIRmGIDRLUskiJ/giphy.gif"> 
    </detailed-instructions>

<br>
      
        <!-- <div class = "row">
            <div class = "col"> -->
    <positive-example> 
       
      <p><b>This is a good example of performing the task.</b></p>
      <p>The image is compressed at a level where image quality is not changed yet, but moving it more will cause it to change.</p>
      <img src="https://media.giphy.com/media/J684vIRmGIDRLUskiJ/giphy.gif">
    
</positive-example>

<!-- </div>
<div class = "col"> -->
    
    <negative-example>
       
      <p><b>This is a bad example of performing the task.</b></p> 
      <p>The image is too compressed and too distorted. Distortion is visible at a much earlier point.</p>
      <img src="https://media.giphy.com/media/Zcp7ZBJOC7iI5mRjhr/giphy.gif">

 </negative-example>
 <!-- </div>
</div> -->



  </crowd-instructions>
  <br>

  <div class="begin_class">
        <h2>Introduction:</h2>
        <p>We are Electrical and Computer Engineering students at the University of Texas as Austin. We are conducting this study for our senior design project to find 
            the optimal compression rate for an image. Your participation will provide valuable data for our project, and 
            we appreciate you taking the time to complete our study.</p>
      <br>
            <h2>Instructions:</h2>
      <p>The slider bar under each image controls the compression level for that image. The highest quality value 
      is 50 and the lowest quality value is 0. Moving the slider to the right will compress the image, causing the
      quality of the image to decrease.</p>
      <img style="text-indent: 25px;" src="https://media.giphy.com/media/J684vIRmGIDRLUskiJ/giphy.gif">
      <p><b>Your task:</b> Adjust the slider to compress the image and try to find the point at which the 
      <b>quality of the image just begins to change</b>. In essence, how far left can you move the slider 
      before the image starts to lose its quality? Your task is <b>not</b> to rate the aesthetic appeal of the image.
      Rather, it is to indicate how much an image can be compressed without decreasing its original quality.</p>
      <p><b>Note:</b> The images may start off with different initial qualities. Base your answer relative to 
      the pristine uncompressed image, when the slider bar is all the way to the right (at 50). With some 
      images, you may be able to move the slider a lot without affecting the quality of the image, while with
      other images, you may not need to move the slider before noticing a drop in quality.</p> 
      <br>
      <div class = "row">
          <div class = "col">
        <p><b> This is a <font color="green">GOOD</font> example of how to perform the task.</b></p>
        <p>The image is compressed at a level where image quality is not changed yet, but moving it more will cause it to change.</p>
        <!-- <img src="https://media.giphy.com/media/Zcp7ZBJOC7iI5mRjhr/giphy.gif"> -->
        <img src="https://media.giphy.com/media/J684vIRmGIDRLUskiJ/giphy.gif"> 
    </div>
        <div class = "col">
        <p><b>This is a <font color="red">BAD</font> example of performing the task.</b></p>
        <p>The image is too compressed and too distorted. <b>Distortion is visible at a much earlier point.</b></p>
        <img src="https://media.giphy.com/media/Zcp7ZBJOC7iI5mRjhr/giphy.gif">
    </div>
    </div>
    <br>
      <p>Perform this task for all of the images.</p>    
      <p>Press 'View instructions' to refer back to these instructions anytime during the study.</p>  
      <!--<p><b>Disclaimer: </b>In order to collect the best results possible, we have quality checks in place to verify the seriousness of your answers, and you will be asked to <b>return the HIT if you fail too many of them. </b></p>  -->
      <p>This task page is supported on Google Chrome, Mozilla Firefox, Microsoft Edge, and Opera. Please use one of these browsers to complete our task.</p>
    
      
  </div>
  
  <div class='tutorial_complete_class'>
      <p>Tutorial complete! When ready, click "Next" to proceed to the full study.</p>
  </div>

  <div class="end_class">
    <p id="task_complete">Task complete! Please click "Submit".</p>
  </div>

<!-- <div  class="progress" id = "progress_class" > -->
<div id ="progress_bar_items" style="display: none;">

    <div id="progressbar" style="height: 20px;width: 100%;"></div>   
    <br>
</div>

<!-- </div> -->
  <div class="tutorial_text_class" style="text-align: center;">
      <p>Tutorial image:</p>
  </div>
  <div class = "row justify-content-center">
      <div class = "col-6">
          <!-- <br> -->
  <div class="image_class">
      
    <img id="source_image"  style="display: none;" crossOrigin="anonymous"> 
    <img id="result_image" style="display: block;" crossOrigin="anonymous">
</div>
</div>
  
<div class="slider_class">
    <p >
      <label  id="text_compression_ratio" fodisr="jpeg_encode_quality">Compression Ratio:</label>
      <input type="text" id="jpeg_encode_quality" readonly style="border:0; color:#f6931f; font-weight:bold;">
    </p>
    <div id="slider" class = slider></div>
</div>
</div>

<div>
        <br>
    <!-- <button type="button" class = "btn btn-primary btn-lg" onclick="setImageb(1)" id='Next_button' value="Next">Next</button>-->
    <p><input type="button" onclick="setImageb(1)" id='Next_button' value="Next" class="btn btn-primary"></input></p> 
    <crowd-input id='set_number' name='set_number' value='initial' type='hidden' style='display: none;'></crowd-input>
    <crowd-input id='slider_values' name='slider_values' value='initial' type='hidden' style='display: none;'></crowd-input>
    <input type="submit" id="submitButton" type='hidden' style='display: none;'>
</div>

</crowd-form>

</div>
</body>
</html>
